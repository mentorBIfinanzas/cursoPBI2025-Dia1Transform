<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guia de transformaciones al diario contable en Power Query</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@500;800&display=swap');

        /* I. Estructura General y Maquetación */
        body {
            font-family: 'Montserrat', sans-serif;
            font-weight: 500; /* Medium */
            line-height: 1.6;
            color: #333;
            background-color: #f9f9f9; /* Coincide con la descripción de "flotar" */
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px 40px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-radius: 8px;
        }

        /* II. Tipografía y Estilo de Texto */
        h1, h2, h3 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800; /* Extrabold */
        }
        
        h1, h2 {
           color: #AEC000;
        }
        
        h3 {
           color: #333; /* Color de texto por defecto para mantener jerarquía */
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        
        h2 {
            font-size: 1.8em;
            border-bottom: 3px solid #AEC000;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        
        h3 {
             font-size: 1.3em;
        }
        
        strong {
           font-weight: 800; /* Extrabold */
        }

        code {
            font-family: 'Courier New', Courier, monospace;
            background-color: #eee;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.9em;
        }

        pre code {
            display: block;
            padding: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        li {
            margin-bottom: 10px;
        }
        
        /* IV. Componentes Reutilizables (Cajas de Información) */
        .intro, .conclusion {
            background-color: #d9d9d9;
            border-left: 5px solid #595959;
            padding: 20px;
            margin: 30px 0;
            border-radius: 4px;
        }

        .explanation-box {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
        }
        
        .why {
            background-color: #FAFFD5;
            border-left: 4px solid #DBF900;
        }
        
        .how {
            background-color: #ffE0B7;
            border-left: 4px solid #ef8600;
        }
        
        /* IV. Componentes Interactivos (Secciones Desplegables) */
        details {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        summary {
            font-weight: 800; /* Extrabold */
            font-size: 1.1em;
            padding: 15px;
            cursor: pointer;
            background-color: #d9d9d9;
            outline: none;
            transition: background-color 0.2s;
        }
        
        details[open] summary {
            background-color: #AEC000;
            color: #333;
        }

        summary::-webkit-details-marker {
            display: none;
        }
        
        summary {
            list-style: none; /* Para Firefox */
        }

        summary::before {
            content: '▶';
            margin-right: 10px;
            transition: transform 0.2s;
        }
        
        details[open] summary::before {
             transform: rotate(90deg);
        }

        .step-content {
            padding: 20px;
            border-top: 1px solid #ddd;
        }

    </style>
</head>
<body>

    <div class="container">
        <!-- ===== IMAGEN INICIAL AÑADIDA AQUÍ ===== -->
        <img src="Isologo_fondo_blanco.svg" alt="Logotipo" style="width: 250px; margin-bottom: 20px;">
        
        <h1><strong>Guía de transformaciones al diario contable en Power Query</strong></h1>

        <div class="intro">
            <p>Esta es una guía paso a paso como complemento de ayuda a las explicaciones en directo del formador. El objetivo es preparar los datos del diario contable en <strong>Power Query</strong>. Para ello, hay que limpiar y modelar la tabla <strong>factDiario</strong> para que sea útil en nuestros análisis financieros en <strong>Power BI</strong>.</p>
            <p><strong>El problema a resolver:</strong> un diario contable contiene todos los movimientos de la empresa. Al final del año, se realizan los <strong>asientos de regularización</strong> para saldar las cuentas de ingresos y gastos (grupos 6 y 7) y llevar su resultado a la cuenta <strong>129 (pérdidas y ganancias)</strong>. Esta es la forma en la que la contabilidad "almacena" en una cuenta las pérdidas o las ganancias de la empresa.</p>
            <p><strong>Para analizar correctamente los resultados, necesitamos eliminar esos asientos de regularización que saldan las cuentas de ingresos y gastos, pero no todos. Debemos conservar los apuntes de la cuenta 129000000, que es, precisamente, la que ha almacenado el resultado final de la empresa.</strong></p>
        </div>

        <h2><strong>Paso a paso</strong></h2>

        <details>
            <summary><strong>Pasos previos: Conectar con el archivo origen y quitar el paso Tipo cambiado</strong></summary>
            <div class="step-content">
                <div class="explanation-box why">
                    <h3><strong>El porqué (la lógica)</strong></h3>
                    <p>Después de habernos conectado al archivo <strong>CSV</strong> que contiene el diario, <strong>Power Query</strong> realiza algunos pasos por defecto (si no hemos cambiado esa configuración). Lo primero que hace es reconocer que la primera fila del archivo no son datos, sino los encabezados de las columnas. Por ello, aparece el paso llamado <strong>Encabezados promovidos</strong> ya hecho en el apartado <strong>PASOS APLICADOS</strong> a la derecha de la pantalla.</p>
                    <p>También genera automáticamente una asignación de tipos de datos a las columnas, pero es una buena práctica eliminar este paso llamado <strong>Tipo cambiado</strong> (que también aparece a la derecha, en el panel llamado <strong>Configuración de la consulta</strong> y dentro de <strong>PASOS APLICADOS</strong>). El motivo de esta buena práctica es que la asignación de tipos de datos a las columnas la haremos nosotros de forma manual y controlada al final del proceso para mejorar el rendimiento.</p>
                </div>
                
                <div class="explanation-box how">
                    <h3><strong>El cómo (la práctica)</strong></h3>
                    <ul>
                        <li>1. <strong>Conexión al origen:</strong> Desde <strong>Power BI</strong>, ficha <strong>Inicio</strong> / grupo <strong>Datos</strong> / <strong>Obtener datos</strong> / <strong>Libro de Excel</strong>. Localiza y selecciona el archivo <strong>factDiario.csv</strong>. Clic en el botón verde <strong>Cargar</strong>.</li>
                        <li>2. <strong>Entrar en Power Query:</strong> Desde <strong>Power BI</strong>, ficha <strong>Inicio</strong> / grupo <strong>Consultas</strong> / <strong>Transformar datos</strong>. Con esta acción, habremos abandonado <strong>Power BI</strong> (que quedará con su ventana minimizada en segundo plano) y se abrirá una nueva ventana que corresponde a la aplicación <strong>Power Query</strong> (es una aplicación-taller, donde se reparan, limpian, depuran y combinan los datos). En la ventana de <strong>Power Query</strong> veremos, a la derecha, el panel <strong>Pasos aplicados</strong>, que refleja todas las transformaciones que <strong>Power Query</strong> realiza por su cuenta y la que nosotros vamos haciendo también. Para ver los pasos aplicados a una determinada consulta, debemos seleccionarla antes a la izquierda, en el panel llamado <strong>Consultas[x]</strong>. Debemos seleccionar la consulta <strong>factDiario.csv</strong> y llevar nuestra mirada al panel <strong>Pasos aplicados</strong> para ver los pasos que <strong>Power Query</strong> ya ha aplicado. Veremos, en este caso, 3 pasos: <strong>Origen</strong>, <strong>Encabezados promovidos</strong> y <strong>Tipo cambiado</strong>. Mientras que el primero es simplemente el paso de conexión al archivo, de los dos restantes hablamos a continuación.</li>
                        <li>3. <strong>Promover encabezados:</strong> Aquí no hay que hacer nada. <strong>Power Query</strong> hace este paso automáticamente (casi siempre) al detectar que la primera fila tiene las características de un encabezado (por ser la única fila de texto en alguna de las columnas de la tabla). Si <strong>Power Query</strong> no detectara esta circunstancia, puedes hacerlo tú manualmente desde la ficha <strong>Inicio</strong> / grupo <strong>Transformar</strong> / <strong>Usar la primera fila como encabezado</strong>.</li>
                        <li>4. <strong>Eliminar tipo cambiado automático:</strong> Si <strong>Power Query</strong> ha añadido un paso llamado <strong>Tipo cambiado</strong> en el panel derecho de <strong>Pasos aplicados</strong>, haz clic en la "X" que aparece a la izquierda del nombre del paso para eliminarlo.</li>
                    </ul>
                </div>
            </div>
        </details>
        
        <details>
            <summary><strong>Paso 1: Columna combinada insertada</strong></summary>
            <div class="step-content">
                <div class="explanation-box why">
                    <h3><strong>El porqué (la lógica)</strong></h3>
                    <p>Nuestra regla de filtrado es compleja: queremos eliminar las filas que contienen <strong>Asiento de regularización</strong> en la descripción, a menos que el número de cuenta sea <strong>129000000</strong>.</p>
                    <p>Para simplificar esta lógica, crearemos una columna auxiliar que una el número de cuenta y la descripción. Así, en lugar de evaluar dos columnas, solo tendremos que buscar un texto único como <strong>129000000-Asiento de regularización</strong>. Esto hará que el siguiente paso, la columna condicional, sea mucho más fácil de construir.</p>
                </div>

                <div class="explanation-box how">
                    <h3><strong>El cómo (la práctica)</strong></h3>
                     <ul>
                        <li>1. <strong>Selecciona las columnas:</strong> Haz clic en el encabezado de la columna <strong>G_L Account No_</strong> para seleccionarla. Luego, mantén presionada la tecla Ctrl y haz clic en el encabezado de la columna <strong>Description_</strong>. El orden de selección es importante.</li>
                        <li>2. <strong>Accede al comando:</strong> Ve a la cinta de opciones, a la ficha <strong>Agregar columna</strong>.</li>
                        <li>3. <strong>Ejecuta la combinación:</strong> En el grupo <strong>De texto</strong>, haz clic en el botón <strong>Combinar columnas</strong>.</li>
                        <li>4. <strong>Configura la combinación:</strong>
                            <ul>
                                <li><strong>Separador:</strong> En el desplegable, elige <strong>--Personalizado--</strong> y escribe un guion (-).</li>
                                <li><strong>Nuevo nombre de columna:</strong> Escribe <strong>Combinada</strong>.</li>
                            </ul>
                        </li>
                        <li>5. Pulsa <strong>Aceptar</strong>. Verás una nueva columna al final de la tabla con el contenido de las dos originales unidas por un guion.</li>
                    </ul>
                </div>
            </div>
        </details>
        
        <details>
            <summary><strong>Paso 2: Columna condicional agregada</strong></summary>
            <div class="step-content">
                <div class="explanation-box why">
                    <h3><strong>El porqué (la lógica)</strong></h3>
                    <p>Este es el cerebro de nuestra transformación. Vamos a crear una columna "bandera" (o flag) que nos diga qué filas conservar (marcando con un <strong>1</strong>) y cuáles descartar (marcando con un <strong>0</strong>). La lógica es la siguiente:</p>
                    <ul>
                        <li>Si la fila es el asiento de regularización de la cuenta <strong>129000000</strong>, le asignamos un <strong>1</strong> (¡la queremos!).</li>
                        <li>Si la fila NO es un asiento de regularización (es un apunte normal del día a día), también le asignamos un <strong>1</strong> (también la queremos).</li>
                        <li>En cualquier otro caso (es decir, es un asiento de regularización de cualquier otra cuenta), le asignamos un <strong>0</strong> (esta la queremos descartar).</li>
                    </ul>
                    <p>Al final, simplemente filtraremos para quedarnos con las filas que tengan un <strong>1</strong>.</p>
                </div>

                <div class="explanation-box how">
                    <h3><strong>El cómo (la práctica)</strong></h3>
                    <ul>
                        <li>1. <strong>Accede al comando:</strong> Ve a la ficha <strong>Agregar columna</strong> / grupo <strong>General</strong> / comando <strong>Columna condicional</strong>.</li>
                        <li>2. <strong>Configura la lógica en la ventana:</strong>
                            <ul>
                                <li><strong>Nuevo nombre de columna:</strong> Deja el nombre que ofrece Power Query por defecto: <strong>Personalizado</strong>.</li>
                                <li><strong>Primera cláusula (la excepción):</strong>
                                    <ul>
                                        <li><em>Si</em> <strong>Nombre de columna:</strong> <strong>Combinada</strong></li>
                                        <li><strong>Operador:</strong> <strong>es igual a</strong></li>
                                        <li><strong>Valor:</strong> <strong>129000000-Asiento de regularización</strong></li>
                                        <li><strong>Salida:</strong> <strong>1</strong></li>
                                    </ul>
                                </li>
                                <li><strong>Añade la segunda cláusula:</strong> Haz clic en <strong>Agregar cláusula</strong>.
                                    <ul>
                                        <li><em>Si no, si</em> <strong>Nombre de columna:</strong> <strong>Combinada</strong></li>
                                        <li><strong>Operador:</strong> <strong>no contiene</strong></li>
                                        <li><strong>Valor:</strong> <strong>Asiento de regularización</strong></li>
                                        <li><strong>Salida:</strong> <strong>1</strong></li>
                                    </ul>
                                </li>
                                <li><strong>Cláusula final (el resto):</strong>
                                    <ul>
                                        <li><em>Si no</em>: <strong>0</strong></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li>3. Pulsa <strong>Aceptar</strong>. Se creará la nueva columna con los valores <strong>1</strong> y <strong>0</strong> según las reglas definidas.</li>
                    </ul>
                </div>
            </div>
        </details>
        
        <details>
            <summary><strong>Paso 3: Filas filtradas</strong></summary>
            <div class="step-content">
                <div class="explanation-box why">
                    <h3><strong>El porqué (la lógica)</strong></h3>
                    <p>Con nuestra columna "bandera" ya creada, el trabajo difícil está hecho. Ahora simplemente filtramos la tabla para mostrar solo las filas marcadas con un <strong>1</strong>.</p>
                </div>

                <div class="explanation-box how">
                    <h3><strong>El cómo (la práctica)</strong></h3>
                    <p>Haz clic en la flecha de filtro del encabezado de la columna <strong>Personalizado</strong>, desmarca la casilla del <strong>0</strong> y pulsa <strong>Aceptar</strong>.</p>
                </div>
            </div>
        </details>
        
        <details>
            <summary><strong>Paso 4: Otras columnas quitadas</strong></summary>
            <div class="step-content">
                <div class="explanation-box why">
                    <h3><strong>El porqué (la lógica)</strong></h3>
                    <p>Una vez hecho el filtro en el paso anterior, muchas columnas no serán necesarias. Entre ellas, las columnas auxiliares (<strong>Combinada</strong> y <strong>Personalizado</strong>). El modo más eficiente de quedarnos solo con lo que necesitamos es seleccionar las columnas que queremos conservar. Además, es recomendable hacerlo con el comando que explicamos a continuación ¡No con el comando "Quitar columnas"!</p>
                </div>

                <div class="explanation-box how">
                    <h3><strong>El cómo (la práctica)</strong></h3>
                    <ul>
                        <li>1. Haz clic en la ficha <strong>Inicio</strong> / grupo <strong>Administrar columnas</strong> / comando <strong>Elegir columnas</strong>.</li>
                        <li>2. En la ventana que aparece, asegúrate de que solo estén marcadas las siguientes columnas: <strong>G_L Account No_</strong>, <strong>Posting Date</strong> y <strong>Amount</strong>. Pulsa <strong>Aceptar</strong>.</li>
                    </ul>
                </div>
            </div>
        </details>

        <details>
            <summary><strong>Paso 5: Primeros caracteres extraídos</strong></summary>
            <div class="step-content">
                <div class="explanation-box why">
                    <h3><strong>El porqué (la lógica)</strong></h3>
                    <p>Los números de cuenta contable suelen tener muchos dígitos para que las personas que gestionan la contabilidad puedan detallar subcuentas (cuentas auxiliares) y, de esta forma, poder tener detalles de muchos gastos e ingresos. Sin embargo, para nuestro modelo de datos, nos interesa relacionar esta tabla con nuestra tabla de plan contable (<strong>dimPGC</strong>) mediante los 4 primeros dígitos (la tabla <strong>dimPGC</strong> tiene las cuentas "recortadas" a 4 dígitos). Por lo tanto, necesitamos truncar el número de cuenta para quedarnos solo con esos primeros 4 caracteres, estandarizando así la clave de relación.</p>
                </div>

                <div class="explanation-box how">
                    <h3><strong>El cómo (la práctica)</strong></h3>
                    <ul>
                        <li>1. <strong>Selecciona la columna</strong> a transformar: <strong>G_L Account No_</strong>.</li>
                        <li>2. <strong>Accede al comando:</strong> Ficha <strong>Transformar</strong> / grupo <strong>Columna de texto</strong> / comando <strong>Extraer</strong> / opción <strong>Primeros caracteres</strong>.</li>
                        <li>3. En la ventana emergente, <strong>escribe</strong> <strong>4</strong> en el campo "Número" y pulsa <strong>Aceptar</strong>.</li>
                    </ul>
                </div>
            </div>
        </details>
        
        <details>
            <summary><strong>Paso 6: Tipo cambiado</strong></summary>
            <div class="step-content">
                <div class="explanation-box why">
                    <h3><strong>El porqué (la lógica)</strong></h3>
                    <p>Este es el último paso de limpieza y depuración. Asignamos el tipo de dato correcto a cada columna para que <strong>Power BI</strong> pueda realizar correctamente los cálculos (moneda para los importes), los análisis de tiempo (fechas) y para que pueda realizar de forma eficiente la relación entre las columnas clave (si las columnas que intervienen en una relación no son del tipo "Número entero", la relación funciona, pero de forma más ineficiente, lo cual puede dejarse notar en una menor velocidad en <strong>Power BI</strong> si trabajamos con millones de filas).</p>
                </div>
                <div class="explanation-box how">
                    <h3><strong>El cómo (la práctica)</strong></h3>
                    <p>Puedes cambiar el tipo haciendo doble clic en el icono que hay a la izquierda del nombre de cada columna (ej: <strong>ABC</strong>, <strong>123</strong>).</p>
                </div>
            </div>
        </details>

        <details>
            <summary><strong>Paso 7: Columnas con nombre cambiado</strong></summary>
            <div class="step-content">
                <div class="explanation-box why">
                    <h3><strong>El porqué (la lógica)</strong></h3>
		    <p>Finalmente, cambiamos los nombres de las columnas a unos más descriptivos y en español.</p>
		    <p><strong>Es crucial que los nombres finales sean exactamente los indicados, ya que las fórmulas DAX que se proporcionarán más adelante dependen de estos nombres específicos (ID_cuenta, Fecha, Importe).</strong></p>
                </div>
                <div class="explanation-box how">
                    <h3><strong>El cómo (la práctica)</strong></h3>
                    <p><strong>Cambiar nombre de columnas:</strong> Haz doble clic en el encabezado de cada columna y escribe el nuevo nombre, o haz clic derecho sobre el encabezado y elige <strong>Cambiar nombre</strong>.</p>
                    <ul>
                        <li><strong>G_L Account No_</strong> → <strong>ID_cuenta</strong></li>
                        <li><strong>Posting Date</strong> → <strong>Fecha</strong></li>
                        <li><strong>Amount</strong> → <strong>Importe</strong></li>
                    </ul>
                </div>
            </div>
        </details>

        <div class="conclusion">
            <h3><strong>¡Ya está casi todo!</strong></h3>
            <p>Ahora, ya podemos salir de <strong>Power Query</strong> guardando todo lo realizado. Esto se hace desde la ficha <strong>Inicio</strong> / grupo <strong>Cerrar</strong> / <strong>Cerrar y aplicar</strong> / <strong>Cerrar y aplicar</strong>.</p>
	    <p>Al seguir estos pasos, automáticamente se cerrará <strong>Power Query</strong> y volveremos a <strong>Power BI</strong>, donde nos encontraremos (a la derecha, en el panel llamado <strong>Datos</strong>), las tablas importadas.</p>
	    <p>Con todo esto, has transformado un diario contable en su estado original en una tabla de hechos limpia, eficiente y lista para ser analizada en <strong>Power BI</strong>. Has aprendido no solo a ejecutar los pasos, sino a comprender la lógica financiera que hay detrás, lo cual es fundamental para crear informes fiables y con sentido.</p>
        </div>

        <!-- ===== IMAGEN FINAL AÑADIDA AQUÍ ===== -->
        <div style="text-align: right; margin-top: 30px;">
            <img src="Isologo_fondo_blanco.svg" alt="Logotipo" style="width: 200px;">
        </div>

    </div>

</body>
</html>
